<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆãƒ¯ãƒ¼ãƒ«ãƒ‰å³æ™‚é›†è¨ˆæ©Ÿ</title>

<style>
body{font-family:sans-serif;background:#111;color:white;}
table{border-collapse:collapse;}
td,th{border:1px solid #555;padding:4px;text-align:center;}

input{
  width:90px;
  background:#222;
  color:white;
  border:1px solid #555;
  text-align:center;
}

.teamInput{width:120px;margin:3px;}
.shortcutInput{width:40px;}

.obs{
  background:black;
  padding:10px;
  margin-top:20px;
  width:420px;
  font-size:22px;
}

.gold{color:#FFD700;font-weight:bold;}
.silver{color:#C0C0C0;font-weight:bold;}
.bronze{color:#CD7F32;font-weight:bold;}
.self{color:#ff4444;font-weight:bold;}
.close{color:#4da6ff;}
.normal{color:white;}

button{margin:4px;}
</style>
</head>

<body>

<h1>ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆãƒ¯ãƒ¼ãƒ«ãƒ‰å³æ™‚é›†è¨ˆæ©Ÿ</h1>

å½¢å¼ï¼š
<select id="formatSelect">
<option value="12">12v12</option>
<option value="8">8v8</option>
<option value="6">6v6</option>
<option value="4">4v4</option>
<option value="3">3v3</option>
<option value="2">2v2</option>
</select>

ãƒ¬ãƒ¼ã‚¹æ•°ï¼š
<select id="raceSelect"></select>

è‡ªãƒãƒ¼ãƒ åï¼š
<input id="myTeamInput">

ç›®æ¨™é †ä½ï¼š
<select id="targetRank"></select>

<br><br>

OBSç”»åƒURLï¼š
<input id="obsImageUrl" style="width:350px">

<br><br>

<button onclick="init()">ç”Ÿæˆ</button>
<button onclick="resetInputs()">ãƒªã‚»ãƒƒãƒˆ</button>

<h2 id="remainRace">æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹: -</h2>
<h2 id="targetStatus">ç›®æ¨™é †ä½: -</h2>
<h2 id="championStatus">å‹åˆ©åˆ¤å®š: -</h2>

<hr>

<div id="teamNameArea"></div>
<br>
<div id="tableArea"></div>

<h2>ã‚³ãƒ”ãƒ¼ç”¨</h2>
<textarea id="copyArea" rows="14" cols="45"></textarea>
<br>
<button onclick="copyScores()">ã‚³ãƒ”ãƒ¼</button>

<h2>OBSè¡¨ç¤ºURL</h2>
<input id="obsURL" style="width:500px" readonly>

<script>

/* ============================= */
const POINT_TABLE=[
15,12,10,9,9,8,8,7,7,6,6,6,
5,5,5,4,4,4,3,3,3,2,2,1
];

let teams=[];
let raceCount=12;
let shortcutMap={};

/* ===== OBSåŒæœŸ ===== */

function saveOBS(text){
  localStorage.setItem("mk_obs_live",JSON.stringify({
    text,
    img:obsImageUrl.value
  }));
}

function loadOBS(){
  return JSON.parse(localStorage.getItem("mk_obs_live")||"{}");
}

const params=new URLSearchParams(location.search);
if(params.get("obs")){
  document.body.innerHTML="<div id='obsLive' class='obs'></div>";

  setInterval(()=>{
    const data=loadOBS();
    if(!data.text) return;

    document.getElementById("obsLive").innerHTML=
      (data.img?`<img src="${data.img}">`:"")+
      data.text.replace(/\n/g,"<br>");
  },300);
}

/* ============================= */

for(let i=8;i<=32;i++){
  raceSelect.append(new Option(i,i));
}

function init(){

  const teamSize=Number(formatSelect.value);
  raceCount=Number(raceSelect.value);
  const teamCount=24/teamSize;

  teams=[];

  targetRank.innerHTML="";
  for(let i=1;i<=teamCount;i++){
    targetRank.append(new Option(`${i}ä½`,i));
  }

  teamNameArea.innerHTML="<h3>ãƒãƒ¼ãƒ è¨­å®š</h3>";

  for(let i=0;i<teamCount;i++){
    const name=`Team${i+1}`;
    teams.push({name,score:0});

    teamNameArea.innerHTML+=`
      ãƒãƒ¼ãƒ ${i+1}
      åå‰:<input class="teamInput" id="teamName${i}">
      SC:<input class="shortcutInput" id="shortcut${i}" maxlength="1"><br>`;
  }

  addEnterMove();
  buildTable();

  obsURL.value=location.origin+location.pathname+"?obs=1";
}

/* ===== Enterã§ä¸‹ç§»å‹• ===== */
function addEnterMove(){
  setTimeout(()=>{
    document.querySelectorAll(".teamInput,.shortcutInput")
    .forEach((el,i,arr)=>{
      el.addEventListener("keydown",e=>{
        if(e.key==="Enter"){
          e.preventDefault();
          if(arr[i+1]) arr[i+1].focus();
        }
      });
    });
  },50);
}

function resetInputs(){
  if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  location.reload();
}

/* ============================= */
/* TABLE */

function buildTable(){

  tableArea.innerHTML="";
  const table=document.createElement("table");

  let head="<tr><th>é †ä½</th>";
  for(let r=1;r<=raceCount;r++) head+=`<th>R${r}</th>`;
  head+="</tr>";
  table.innerHTML=head;

  for(let rank=1;rank<=24;rank++){

    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${rank}</td>`;

    for(let r=0;r<raceCount;r++){

      const td=document.createElement("td");
      const input=document.createElement("input");

      input.dataset.rank=rank;
      input.dataset.race=r;
      input.dataset.team="";

      input.addEventListener("keydown",(e)=>{

        if(e.key==="Enter"){
          e.preventDefault();
          moveNext(input);
          return;
        }

        if(e.key==="Backspace"){
          e.preventDefault();
          input.value="";
          input.dataset.team="";
          recalcScores();
          return;
        }

        const key=e.key.toLowerCase();
        if(shortcutMap[key]!==undefined){
          e.preventDefault();
          const idx=shortcutMap[key];
          input.dataset.team=idx;
          input.value=teams[idx].name;
          moveNext(input);
          recalcScores();
        }
      });

      input.addEventListener("input",()=>{
        const val=input.value.toLowerCase();

        const found=teams.findIndex(t=>
          t.name.toLowerCase().startsWith(val)
        );

        if(found!==-1){
          input.dataset.team=found;
        }

        autoFillRemaining(input.dataset.race);
        recalcScores();
      });

      td.appendChild(input);
      tr.appendChild(td);
    }

    table.appendChild(tr);
  }

  tableArea.appendChild(table);
}

/* ===== è‡ªå‹•è£œå®Œ ===== */
function autoFillRemaining(race){

  const col=[...document.querySelectorAll(`input[data-race="${race}"]`)];
  const counts=new Array(teams.length).fill(0);

  col.forEach(i=>{
    if(i.dataset.team!==""){
      counts[Number(i.dataset.team)]++;
    }
  });

  const teamSize=24/teams.length;
  const remain=counts
    .map((c,i)=>c<teamSize?i:null)
    .filter(v=>v!==null);

  if(remain.length!==1) return;

  col.forEach(input=>{
    if(input.dataset.team===""){
      input.dataset.team=remain[0];
      input.value=teams[remain[0]].name;
    }
  });
}

/* ============================= */

function moveNext(input){
  const race=Number(input.dataset.race);
  const rank=Number(input.dataset.rank);

  let next=document.querySelector(
    `input[data-race="${race}"][data-rank="${rank+1}"]`
  );

  if(!next){
    next=document.querySelector(
      `input[data-race="${race+1}"][data-rank="1"]`
    );
  }

  if(next) next.focus();
}

/* ===== æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹ ===== */
function getRemainingRaces(){
  let finished=0;
  for(let r=0;r<raceCount;r++){
    const col=[...document.querySelectorAll(`input[data-race="${r}"]`)];
    if(col.every(i=>i.dataset.team!=="")) finished++;
  }
  return raceCount-finished;
}

/* ===== æœ€å¤§ç‚¹å·® ===== */
function calcMaxSwing(){
  const teamSize=Number(formatSelect.value);
  let max=0,min=0;
  for(let i=0;i<teamSize;i++){
    max+=POINT_TABLE[i];
    min+=POINT_TABLE[POINT_TABLE.length-1-i];
  }
  return max-min;
}

/* ============================= */

function recalcScores(){

  teams.forEach(t=>t.score=0);
  shortcutMap={};

  teams.forEach((t,i)=>{
    t.name=document.getElementById(`teamName${i}`).value;
    const sc=document.getElementById(`shortcut${i}`).value.toLowerCase();
    if(sc) shortcutMap[sc]=i;
  });

  document.querySelectorAll("input[data-rank]").forEach(input=>{
    if(input.dataset.team==="") return;
    const teamIndex=Number(input.dataset.team);
    const rank=Number(input.dataset.rank);
    teams[teamIndex].score+=POINT_TABLE[rank-1];
  });

  const sorted=[...teams].sort((a,b)=>b.score-a.score);
  const myTeam=myTeamInput.value.trim();

  const remain=getRemainingRaces();
  remainRace.textContent=`æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹: ${remain}`;

  /* å‹åˆ©ç¢ºå®šåˆ¤å®š */
  let champion="æœªç¢ºå®š";
  if(sorted.length>1){
    const swing=calcMaxSwing()*remain;
    const diff=sorted[0].score-sorted[1].score;
    if(diff>swing) champion="ğŸ† å‹åˆ©ç¢ºå®š";
  }
  championStatus.textContent=`å‹åˆ©åˆ¤å®š: ${champion}`;

  /* ç›®æ¨™é †ä½è¡¨ç¤º */
  const target=Number(targetRank.value||1);
  targetStatus.textContent=`ç›®æ¨™é †ä½: ${target}ä½ / ${teams.length}ä½`;

  let text=`æ®‹ã‚Š${remain}ãƒ¬ãƒ¼ã‚¹\n${champion}\n\n`;

  sorted.forEach((team,i)=>{

    let cls="normal";
    const diff=sorted[0].score-team.score;

    if(team.name===myTeam) cls="self";
    else if(i===0) cls="gold";
    else if(i===1) cls="silver";
    else if(i===2) cls="bronze";
    else if(diff<=8) cls="close";

    text+=`${i+1}. ${team.name} ${team.score}pts\n`;
  });

  copyArea.value=text;
  saveOBS(text);
}

function copyScores(){
  copyArea.select();
  document.execCommand("copy");
}

</script>
</body>
</html>
